name: Cl

on: [push, workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download ngrok
      run: Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
      
    - name: Extract ngrok
      run: Expand-Archive ngrok.zip -DestinationPath .
      
    - name: Auth ngrok
      run: .\ngrok.exe authtoken $env:NGROK_TOKEN
      env:
        NGROK_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        
    - name: Enable RDP
      run: |
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -name "fDenyTSConnections" -Value 0 -Force
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1 -Force
      
    - name: Create User
      run: Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
      
    - name: Start ngrok
      run: Start-Process -NoNewWindow -FilePath ".\ngrok.exe" -ArgumentList "tcp 3389"
      
    - name: Get VDS Info from API
      run: |
        $maxRetries = 30
        $retryCount = 0
        $vdsUrl = $null
        
        # ngrok API endpoint
        $apiUrl = "http://localhost:4040/api/tunnels"
        
        while ($retryCount -lt $maxRetries) {
          try {
            $response = Invoke-WebRequest -Uri $apiUrl -UseBasicParsing -TimeoutSec 5 -ErrorAction Stop
            $data = $response.Content | ConvertFrom-Json
            
            # Tunnel bulundu mu kontrol et
            if ($data.tunnels -and $data.tunnels.Count -gt 0) {
              $tunnel = $data.tunnels | Where-Object { $_.proto -eq "tcp" } | Select-Object -First 1
              
              if ($tunnel) {
                $vdsUrl = $tunnel.public_url
                Write-Host "âœ“ VDS Tunnel bulundu: $vdsUrl"
                break
              }
            }
          } catch {
            $retryCount++
            Write-Host "â³ Tunnel baÅŸlÄ±yor... Deneme: $retryCount/$maxRetries"
            Start-Sleep -Seconds 2
          }
        }
        
        # EÄŸer URL bulunamadÄ±ysa hata ver
        if (-not $vdsUrl) {
          Write-Host "âœ— HATA: VDS URL 60 saniye iÃ§inde alÄ±namadÄ±!"
          exit 1
        }
        
        # URL'den bilgileri ayÄ±kla
        $urlPattern = $vdsUrl -replace "tcp://", ""
        $hostPort = $urlPattern -split ":"
        $host = $hostPort[0]
        $port = if ($hostPort.Count -gt 1) { $hostPort[1] } else { "3389" }
        
        # VDS bilgilerini kaydet
        $vdsInfo = @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       VDS BAGLANTI BILGILERI           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… OluÅŸturma ZamanÄ±: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')

ğŸŒ BAGLANTI ADRESLERI:
   â€¢ Genel URL: $vdsUrl
   â€¢ Host: $host
   â€¢ Port: $port

ğŸ–¥ï¸  SUNUCU BILGILERI:
   â€¢ Ä°ÅŸletim Sistemi: Windows Server
   â€¢ RDP Servisi: Aktif
   â€¢ GÃ¼venlik: Etkin

ğŸ‘¤ GÄ°RÄ°Å BÄ°LGÄ°LERÄ°:
   â€¢ KullanÄ±cÄ± AdÄ±: runneradmin
   â€¢ Åifre: P@ssw0rd!

ğŸ“‹ BAGLANTI ADIMLARI:
   1. RDP istemcisini aÃ§ (mstsc.exe)
   2. Sunucu AdÄ±na yaz: $host:$port
   3. KullanÄ±cÄ± AdÄ±: runneradmin
   4. Åifre: P@ssw0rd! gir
   5. BaÄŸlan'a tÄ±kla

âš ï¸  Ã–NEMLÄ° NOTLAR:
   â€¢ Bu session sÄ±nÄ±rlÄ± sÃ¼re iÃ§in aktiftir
   â€¢ ngrok aracÄ±lÄ±ÄŸÄ± ile baÄŸlantÄ± saÄŸlanÄ±r
   â€¢ TÃ¼m veri ÅŸifreli iletilir
"@
        
        # TXT formatÄ±nda kaydet
        $vdsInfo | Out-File -FilePath "vds-info.txt" -Encoding UTF8 -Force
        
        # JSON formatÄ±nda kaydet
        $jsonData = @{
          url = $vdsUrl
          host = $host
          port = $port
          username = "runneradmin"
          password = "P@ssw0rd!"
          timestamp = (Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          status = "active"
        } | ConvertTo-Json
        
        $jsonData | Out-File -FilePath "vds-info.json" -Encoding UTF8 -Force
        
        # Ekrana yazdÄ±r
        Write-Host ""
        Write-Host $vdsInfo
        Write-Host ""
        Write-Host "âœ“ VDS bilgileri baÅŸarÄ±yla kaydedildi!"
      
    - name: Display VDS Info
      run: Get-Content vds-info.txt
      
    - name: Upload Info Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vds-connection-info
        path: |
          vds-info.txt
          vds-info.json
      if: always()
      
    - name: Keep Session Alive
      run: |
        Write-Host ""
        Write-Host "ğŸŸ¢ VDS Session baÅŸarÄ±yla oluÅŸturuldu!"
        Write-Host "ğŸ“¥ BaÄŸlantÄ± bilgilerini 'Artifacts' bÃ¶lÃ¼mÃ¼nden indirebilirsiniz."
        Write-Host ""
        Start-Sleep -Seconds 3600
