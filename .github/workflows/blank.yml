name: Cl

on: [push, workflow_dispatch]

jobs:
  build:

    runs-on: windows-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Download
      run: Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
      
    - name: Extract
      run: Expand-Archive ngrok.zip
      
    - name: Auth
      run: .\ngrok\ngrok.exe authtoken $Env:NGROK_AUTH_TOKEN
      env:
        NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        
    - name: Enable TS
      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server'-name "fDenyTSConnections" -Value 0
      
    - name: Enable RDP Firewall
      run: Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
      
    - name: Set RDP Authentication
      run: Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -name "UserAuthentication" -Value 1
      
    - name: Create User Password
      run: Set-LocalUser -Name "runneradmin" -Password (ConvertTo-SecureString -AsPlainText "P@ssw0rd!" -Force)
      
    - name: Start ngrok Tunnel
      run: Start-Process -NoNewWindow -FilePath ".\ngrok\ngrok.exe" -ArgumentList "tcp 3389"
      
    - name: Get VDS IP and Save
      run: |
        $maxAttempts = 30
        $attempt = 0
        $vdsUrl = $null
        
        # ngrok API'den VDS URL'sini al
        while ($attempt -lt $maxAttempts) {
          try {
            $response = Invoke-WebRequest -Uri "http://localhost:4040/api/tunnels" -UseBasicParsing -ErrorAction Stop
            $tunnels = $response.Content | ConvertFrom-Json
            
            if ($tunnels.tunnels.Count -gt 0) {
              $vdsUrl = $tunnels.tunnels[0].public_url
              Write-Host "âœ“ ngrok tunnel hazÄ±r! URL: $vdsUrl"
              break
            }
          } catch {
            $attempt++
            Write-Host "â³ Tunnel baÅŸlÄ±yor... ($attempt/$maxAttempts)"
            Start-Sleep -Seconds 2
          }
        }
        
        if (-not $vdsUrl) {
          Write-Host "âœ— Tunnel baÅŸlatÄ±lamadÄ±!"
          exit 1
        }
        
        # URL'den host ve port'u ayÄ±kla (tcp://host:port formatÄ±nda)
        $urlParts = $vdsUrl -replace "tcp://", "" -split ":"
        $host = $urlParts[0]
        $port = if ($urlParts.Count -gt 1) { $urlParts[1] } else { "3389" }
        
        # VDS bilgilerini kaydet
        $content = @"
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘       VDS BAGLANTI BILGILERI           â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“… OluÅŸturma ZamanÄ±: $(Get-Date -Format "yyyy-MM-dd HH:mm:ss")

ğŸŒ BAGLANTI ADRESLERI:
   â€¢ Genel URL: $vdsUrl
   â€¢ Host: $host
   â€¢ Port: $port

ğŸ–¥ï¸  SUNUCU BILGILERI:
   â€¢ TÃ¼rÃ¼: Windows RDP
   â€¢ Ä°ÅŸletim Sistemi: Windows Server

ğŸ‘¤ GÄ°RÄ°Å BÄ°LGÄ°LERÄ°:
   â€¢ KullanÄ±cÄ± AdÄ±: runneradmin
   â€¢ Åifre: P@ssw0rd!

ğŸ“‹ BAGLANTI ADIMLARI:
   1. RDP istemcisini aÃ§
   2. Sunucu AdÄ±: $host:$port
   3. KullanÄ±cÄ± AdÄ±: runneradmin
   4. Åifre: P@ssw0rd!
   5. BaÄŸlan'a tÄ±kla

âš ï¸  NOT: Bu session sÄ±nÄ±rlÄ± sÃ¼re iÃ§in aktiftir.
"@
        
        $content | Out-File -FilePath "vds-info.txt" -Encoding UTF8
        
        # JSON olarak da kaydet
        @{
          url = $vdsUrl
          host = $host
          port = $port
          username = "runneradmin"
          password = "P@ssw0rd!"
          timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        } | ConvertTo-Json | Out-File -FilePath "vds-info.json" -Encoding UTF8
        
        Write-Host "âœ“ VDS bilgileri kaydedildi!"
      
    - name: Display VDS Info
      run: Get-Content vds-info.txt
      
    - name: Upload Connection Info
      uses: actions/upload-artifact@v4
      with:
        name: vds-connection-info
        path: |
          vds-info.txt
          vds-info.json
      if: always()
      
    - name: Keep Session Alive
      run: |
        Write-Host "ğŸŸ¢ VDS Session baÅŸarÄ±yla oluÅŸturuldu!"
        Write-Host "Artifact'tan baÄŸlantÄ± bilgilerini indirebilirsiniz."
        while($true) { 
          Start-Sleep -Seconds 60 
        }
